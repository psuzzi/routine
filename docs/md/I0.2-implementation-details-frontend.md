# Routine App Stage 1: Initial Prototype (Monolithic) - Detailed Instructions

This document outlines the structure and implementation of the dev.algo.routine full stack application.
Specifically, this document addresses how the monolithic application is built

## 2. Frontend Setup

### 2.1 Create a new React project

1. Open a terminal and navigate to your desired directory
2. Run: `npx create-react-app frontend --template typescript`
3. Navigate to the project folder: `cd frontend`

### 2.2 Install necessary dependencies

Run the following command:

```
npm install react-router-dom axios @types/react-router-dom
```

### 2.3 Set up basic routing

1. Create a new folder `src/components`
2. Create the following files in the `components` folder:
    - `Login.tsx`
    - `Register.tsx`
    - `TaskList.tsx`
    - `TaskForm.tsx`
3. Update `src/App.tsx`:

This `App` component sets up the main routing structure for the application using React Router v6. 
It defines routes for login, registration, task list, and task form pages, with a default redirection to the login page. 
Note: Router v6 uses `Route` and `Navigate` components for redirection, instead of the older `Redirect`.

```tsx
import React from 'react';
import { BrowserRouter as Router, Route, Routes, Navigate } from 'react-router-dom';
import Login from './components/Login';
import Register from './components/Register';
import TaskList from './components/TaskList';
import TaskForm from './components/TaskForm';
import './App.css';


function App() {
  return (
    <Router>
      <div className="App">
        <Routes>
          <Route path="/login" element={<Login />} />
          <Route path="/register" element={<Register />} />
          <Route path="/tasks" element={<TaskList />} />
          <Route path="/task" element={<TaskForm />} />
          <Route path='/task/:id' element={<TaskForm />} />
          <Route path="/" element={<Navigate to="/login" replace />} />
        </Routes>
      </div>
    </Router>
  );
}

export default App;
```

### 2.4 Implement components

The `Register` component handles user registration. 
It manages for state using React hooks, sends registration requests to the backend API,
and navigates to the login page upon successful registration. 


1. Update `src/components/Register.tsx`:

```tsx
import React, {useState} from "react";
import axios from "axios";
import { useNavigate } from "react-router-dom";

const Register: React.FC = () => {
    // State hooks to manage form input values
    const [username, setUsername] = useState<string>("");
    const [password, setPassword] = useState<string>("");
    const [email, setEmail] = useState<string>(""); 
    
    const navigate = useNavigate();

    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();
        try {
            await axios.post("/api/user/register", {
                username,
                password,
                email
            });
            navigate("/login");
        } catch (error) {
            console.log(error);
        }
    };

    return (
        <form onSubmit={handleSubmit}>
            <input
                type="text"
                placeholder="Username"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
            />
            <input
                type="password"
                placeholder="Password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
            />
            <input
                type="email"
                placeholder="Email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
            />
            <button type="submit">Register</button>
        </form>
    )
}

export default Register;
```

Note: this component uses react-router-dom v6. 
For earlier versions you might need `useHistory` instead of `useNavigate`

2. Update `src/components/Login.tsx`:

The `Login` component manages user authentication. 
It handles login form submission, stores the authentication token, and navigates to the task list upon successful login.

```tsx
import React, { useState } from 'react';
import axios from 'axios'
import { useNavigate } from 'react-router-dom';

const Login: React.FC = () => {
    const [username, setUsername] = useState<string>("");
    const [password, setPassword] = useState<string>("");
    const navigate = useNavigate();

    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();
        try {
            const response = await axios.post("/api/login", {
                username,
                password
            });
            localStorage.setItem("token", response.data.token);
            navigate("/tasks");
        } catch (error) {
            console.log('Login failed', error);
        }
    }

    return (
        <form onSubmit={handleSubmit}>
            <input
                type="text"
                placeholder="Username"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
            />
            <input
                type="password"
                placeholder="Password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
            />
            <button type="submit">Login</button>
        </form>
    )
}

export default Login;
```

3. Update `src/components/TaskList.tsx`:

The `TaskList` component fetches and displays tasks, allowing users to mark tasks as complete. 
It sues React hooks for state management and side effects, and includes authentication via Bearer token.


```tsx
import React, { useState, useEffect } from 'react'
import axios from 'axios'
import { Link } from 'react-router-dom'

interface Task {
    id: number;
    title: string;
    description: string;
    dueDate: string
    completed: boolean;
}

const TaskList: React.FC = () => {

    const [tasks, setTasks] = useState<Task[]>([]);

    useEffect(() => {
        // Fetch tasks when component mounts
        const fetchTasks = async () => {
            try {
                const response = await axios.get<Task[]>('/api/tasks', {
                    headers: {
                        Authorization: `Bearer ${localStorage.getItem('token')}`
                    }
                });
                setTasks(response.data);
            }
            catch (error) {
                console.log('Error fetching tasks', error);
            }
        }

        fetchTasks()
    }, [])

    const handleComplete = async (id: number) => {
        try {
            // Update task completion status
            await axios.put(`/api/tasks/${id}`, { completed: true }, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`
                }
            })
            setTasks(tasks.map(task => {
                if (task.id === id) {
                    task.completed = !task.completed;
                }
                return task;
            }))
        } catch (error) {
            console.log('Error completing task', error)
        }
    }

    return (
        <div>
            <h1>Tasks</h1>
            <Link to="/new-task">Add Task</Link>
            <ul>
                {tasks.map(task => (
                    <li key={task.id}>
                        {task.title} - {task.dueDate}
                        {!task.completed && <button onClick={() => handleComplete(task.id)}>Complete</button>}
                    </li>
                ))}
            </ul>
        </div>
    )
}

export default TaskList;
```

4. Update `src/components/TaskForm.tsx`:

The `TaskForm` component allows users to create new tasks. It manages form state for task details and submits the new task to the backend API.

```tsx
import React, { useState } from 'react'
import axios from 'axios'
import { useNavigate } from 'react-router-dom'

const TaskForm: React.FC = () => {
    const [title, setTitle] = useState<string>('')
    const [description, setDescription] = useState<string>('')
    const [dueDate, setDueDate] = useState<string>('')
    const navigate = useNavigate()

    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();
        try {
            await axios.post("/api/tasks", {
                title,
                description,
                dueDate
            }, {
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`
                }
            });
            navigate("/tasks");
        } catch (error) {
            console.log('Error creating task', error);
        }
    }

    return (
        <form onSubmit={handleSubmit}>
            <input
                type="text"
                placeholder="Title"
                value={title}
                onChange={(e) => setTitle(e.target.value)}
            />
            <input
                type="text"
                placeholder="Description"
                value={description}
                onChange={(e) => setDescription(e.target.value)}
            />
            <input
                type="date"
                placeholder="Due Date"
                value={dueDate}
                onChange={(e) => setDueDate(e.target.value)}
            />
            <button type="submit">Create Task</button>
        </form>
    )
}

export default TaskForm;
```

### 2.5 Create API service

1. Create a `.env` file :

Add an env file to the base of your React app. 
The file will specify the base URL for sending the requests.

```properties
REACT_APP_API_BASE_URL=http://localhost:8080/api
```

1. Create a new file `src/services/api.ts`:

This API serviec creates a configured Axios instance for making authenticated requests to the backend.


```typescript
import axios from 'axios'

const api = axios.create({
    // environment variable to set the base URL
    baseURL: process.env.REACT_APP_API_BASE_URL || 'http://localhost:8080/api',
})

api.interceptors.request.use(config => {
    const token = localStorage.getItem('token')
    if (token) {
        config.headers.Authorization = `Bearer ${token}`
    }
    return config
})

export default api;
```

2. Update the components to use this API service instead of axios directly.

In all the components, replace the axios import with the api, 
and then use the api to perform the calls. 

```tsx
import api from '../services/api';
//...
response = await api.post("/login" // .. 
```

### 2.6 Basic state management with React Context

The `AuthContext` provides a way to manage authentication state across the application.
It includes a custom hook `useAuth` for easy access to the authentication context.

1. Create a new file `src/context/AuthContext.tsx`:

```tsx
import React, { createContext, useState, useContext, ReactNode } from 'react'

interface AuthContextType {
    isAuthenticated: boolean;
    setIsAuthenticated: (value: boolean) => void;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

// Define a type for the props of AuthProvider
interface AuthProviderProps {
    children: ReactNode;
}

// Use the defined props type instead of React.FC
export const AuthProvider = ({children}: AuthProviderProps) => {
    const [isAuthenticated, setIsAuthenticated] = useState<boolean>(false);

    return (
        <AuthContext.Provider value={{ isAuthenticated, setIsAuthenticated }}>
            {children}
        </AuthContext.Provider>
    )
}

export const useAuth = () => {
    const context = useContext(AuthContext);
    if (context === undefined) {
        throw new Error('useAuth must be used within an AuthProvider')
    }
    return context;
}
```

2. Update `src/App.tsx` to use the AuthProvider:

```tsx
import React from 'react';
import { BrowserRouter as Router, Route, Routes, Navigate } from 'react-router-dom';
import { AuthProvider } from './context/AuthContext';
import Login from './components/Login';
import Register from './components/Register';
import TaskList from './components/TaskList';
import TaskForm from './components/TaskForm';


function App() {
  return (
    <AuthProvider>
      <Router>
        <div className="App">
          <Routes>
            <Route path="/login" element={<Login />} />
            <Route path="/register" element={<Register />} />
            <Route path="/tasks" element={<TaskList />} />
            <Route path="/task" element={<TaskForm />} />
            <Route path='/task/:id' element={<TaskForm />} />
            <Route path="/" element={<Navigate to="/login" replace />} />
          </Routes>
        </div>
      </Router>
    </AuthProvider>
  );
}

export default App;

```

### 2.7 Running and Testing the Frontend


To run and test the frontend: 

1. Navigate to the frontend directory: `cd frontend`
2. Install dependencies if not done already `npm install`
3. Start the development server `npm start`
4. open the browser and visit http://localhost:3000
5. Test the applicatio by:
  - registering a new user
  - logging in with the registered credentials
  - creating new tasks
  - viewing and completing tasks
6. To run tests (if yo've written any): `npm test`

Remember to ensure your backend server is running and accessible for full functionality testing



## 3. CI/CD Setup

### 3.1 Create GitHub Actions workflow

1. Create a `.github/workflows` directory in your project root.
2. Create a new file `.github/workflows/ci-cd.yml`:

```yaml
name: CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up JDK 17
      uses: actions/setup-java@v2
      with:
        java-version: '17'
        distribution: 'adopt'

    - name: Build with Maven
      run: mvn clean install

    - name: Run tests
      run: mvn test

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v2

    - name: Deploy to Heroku
      uses: akhileshns/heroku-deploy@v3.12.12
      with:
        heroku_api_key: ${{secrets.HEROKU_API_KEY}}
        heroku_app_name: "your-heroku-app-name"
        heroku_email: "your-email@example.com"
```

### 3.2 Set up Heroku

1. Create a Heroku account if you don't have one.
2. Create a new Heroku app.
3. In your GitHub repository settings, add the following secrets:
    - HEROKU_API_KEY: Your Heroku API key
    - HEROKU_APP_NAME: Your Heroku app name
    - HEROKU_EMAIL: Your Heroku account email

### 3.3 Configure the application for Heroku

1. Create a `Procfile` in the root of your project:

```
web: java -jar target/routine-app-0.0.1-SNAPSHOT.jar
```

2. Update `src/main/resources/application.properties` to use environment variables:

```properties
spring.datasource.url=${DATABASE_URL}
spring.datasource.username=${DATABASE_USERNAME}
spring.datasource.password=${DATABASE_PASSWORD}
spring.jpa.hibernate.ddl-auto=update
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
```

3. In your Heroku app settings, set the config vars for DATABASE_URL, DATABASE_USERNAME, and DATABASE_PASSWORD.

This completes the detailed instructions for implementing Stage 1: Initial Prototype (Monolithic) of your Routine App project. The next steps would involve testing the application thoroughly, addressing any bugs or issues, and preparing for the transition to Stage 2: MVP (Modular Monolith).